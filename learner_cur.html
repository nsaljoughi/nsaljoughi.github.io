<script src="https://aframe.io/releases/0.9.2/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/gftruj/AR.js@enable-custom-area-markers-build/aframe/build/aframe-ar.js"></script> 
<script src="three.stats.js"></script>
<body style='margin : 0px; overflow: hidden; font-family: Monospace;'>
  <div style='position: absolute; top: 10px; width:100%; text-align: center;z-index:1';>
    <a href='https://github.com/jeromeetienne/AR.js/' target='_blank'>AR.js</a> - Multi marker
    by <a href='https://twitter.com/jerome_etienne' target='_blank'>@jerome_etienne</a>
    <br/>
    Status:
    <span id='appStatus' style='font-weight: bolder;'>stopped</span>
    - 
    File:
    <span id='dataStatus' style='font-weight: bolder;'>none</span>
    <br/>
    <a href='javascript:void(0)' onclick='onRecordClear()'>Clear File</a>
  </div>
  <div style='position: fixed; bottom: 16px; right: 16px; z-index:2';>
    <img id='recordStartButton' src="https://cdn.glitch.com/2eeb7d95-c8cf-4303-bd86-62eee247fedf%2Fstop.png?v=1562098447408" width='64px'  height='64px' onclick='onRecordStart()'>
    <img id='recordStopButton' src="https://cdn.glitch.com/2eeb7d95-c8cf-4303-bd86-62eee247fedf%2Fstop.png?v=1562098447408" width='64px'  height='64px' onclick='onRecordStop()' style='display: none;'>
  </div>
  <div style='position: fixed; bottom: 16px; left: 16px; z-index:2' id='markersStatus';>
    <div>
      Tracking <span class='labelTrackingBackend'>Unknown</span> - 
      Learning <span class='globalStatus'>Stopped</span>
    </div>
    <ul></ul>
  </div>
<script>
;(function(){
//////////////////////////////////////////////////////////////////////////////////
//		Init
//////////////////////////////////////////////////////////////////////////////////
// init renderer
var renderer	= new THREE.WebGLRenderer({
  // antialias	: true,
  alpha: true
});

document.body.appendChild( renderer.domElement );
  
// array of functions for the rendering loop
var onRenderFcts= [];
// init scene and camera
var scene	= new THREE.Scene();
//////////////////////////////////////////////////////////////////////////////
//		parse urlOptions
//////////////////////////////////////////////////////////////////////////////

var urlOptions = {
  backURL : null,
  trackingBackend: 'artoolkit',
  markersControlsParameters: [
    {type: 'pattern', patternUrl: 'celtich.patt'},
    {type: 'pattern', patternUrl: 'celticu.patt'},
    {type: 'pattern', patternUrl: 'likeaboss.patt'}
    ]
}
console.log(urlOptions)
//////////////////////////////////////////////////////////////////////////////////
//		Initialize a basic camera
//////////////////////////////////////////////////////////////////////////////////
// Create a camera
if( urlOptions.trackingBackend === 'aruco' ){
  var camera = new THREE.PerspectiveCamera(42, renderer.domElement.width / renderer.domElement.height, 0.01, 100);
}else if( urlOptions.trackingBackend === 'artoolkit' ){
  var camera = new THREE.Camera();
}else console.assert(false)
scene.add(camera);
////////////////////////////////////////////////////////////////////////////////
//          handle arToolkitSource
////////////////////////////////////////////////////////////////////////////////
var artoolkitProfile = new THREEx.ArToolkitProfile()
artoolkitProfile.sourceWebcam()
var arToolkitSource = new THREEx.ArToolkitSource(artoolkitProfile.sourceParameters)
arToolkitSource.init(function onReady(){
  onResize()
})

function onResize(){
  arToolkitSource.onResizeElement()
  arToolkitSource.copyElementSizeTo(renderer.domElement)	
  if( urlOptions.trackingBackend === 'aruco' ){
    arToolkitSource.copyElementSizeTo(arToolkitContext.arucoContext.canvas)	
    camera.aspect = renderer.domElement.width / renderer.domElement.height;
    camera.updateProjectionMatrix();			
  }else if( urlOptions.trackingBackend === 'artoolkit' ){
    if( arToolkitContext.arController !== null ){
      arToolkitSource.copyElementSizeTo(arToolkitContext.arController.canvas)	
    }	
  }else console.assert(false)
}
////////////////////////////////////////////////////////////////////////////////
//          initialize arToolkitContext
////////////////////////////////////////////////////////////////////////////////	
// honor urlOptions.trackingBackend
artoolkitProfile.contextParameters.trackingBackend = urlOptions.trackingBackend
// create atToolkitContext
var arToolkitContext = new THREEx.ArToolkitContext(artoolkitProfile.contextParameters)
// initialize it
arToolkitContext.init(function onCompleted(){
  // if artoolkit, copy projection matrix to camera
  if( arToolkitContext.parameters.trackingBackend === 'artoolkit' ){
    camera.projectionMatrix.copy( arToolkitContext.getProjectionMatrix() );			
  }
})
// update artoolkit on every frame
onRenderFcts.push(function(){
  if( arToolkitSource.ready === false )	return
  arToolkitContext.update( arToolkitSource.domElement )
})

//////////////////////////////////////////////////////////////////////////////
//		learn
//////////////////////////////////////////////////////////////////////////////
// prepare the parameters
var subMarkersControls = []
urlOptions.markersControlsParameters.forEach(function(markerControlsParameters){
  // create a markerRoot
  var markerRoot = new THREE.Group()
  scene.add(markerRoot)
  // create markerControls for our markerRoot
  var markerControls = new THREEx.ArMarkerControls(arToolkitContext, markerRoot, markerControlsParameters)

  // TODO here put a THREEx.ArSmoothedControls behind a flag - could be useful for tunning

  // add an helper to visuable each sub-marker
  var markerHelper = new THREEx.ArMarkerHelper(markerControls)
  markerControls.object3d.add( markerHelper.object3d )			

  // store it in the parameters
    subMarkersControls.push(markerControls)
})

var multiMarkerLearning = new THREEx.ArMultiMakersLearning(arToolkitContext, subMarkersControls)
// window.multiMarkerLearning = multiMarkerLearning
multiMarkerLearning.enabled = false
//////////////////////////////////////////////////////////////////////////////
//		UI Functions
//////////////////////////////////////////////////////////////////////////////

function onRecordStart(){
  // cant be started, if it is already started
  if( multiMarkerLearning.enabled === true ){
    console.log('already started')
    return
  }
  // reset previously collected statistics
  multiMarkerLearning.resetStats()

  // enabled data collection
  multiMarkerLearning.enabled = true
}

// update markersStatus 10 time per seconds
setInterval(function(){
// return
  // compute result
  multiMarkerLearning.computeResult()
}, 1000/10)
onRecordStart()
  
//////////////////////////////////////////////////////////////////////////////////
//		render the whole thing on the page
//////////////////////////////////////////////////////////////////////////////////
var stats = new Stats();
// document.body.appendChild( stats.dom );
// render the scene
onRenderFcts.push(function(){
  renderer.render( scene, camera );
  stats.update();
})
// run the rendering loop
var lastTimeMsec= null
requestAnimationFrame(function animate(nowMsec){
  // keep looping
  requestAnimationFrame( animate );
  // measure time
  lastTimeMsec	= lastTimeMsec || nowMsec-1000/60
  var deltaMsec	= Math.min(200, nowMsec - lastTimeMsec)
  lastTimeMsec	= nowMsec
  // call each update function
  onRenderFcts.forEach(function(onRenderFct){
    onRenderFct(deltaMsec/1000, nowMsec/1000)
  })
})
})()
</script></body>
